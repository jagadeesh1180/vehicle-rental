<!DOCTYPE html>
<html>
<head>
  <title>User | Nearby Vehicles</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
    }

    .topbar {
      background: #000;
      border-bottom: 1px solid #333;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .topbar h5 {
      margin: 0;
      font-weight: 600;
    }

    #map {
      height: calc(100vh - 60px);
      width: 100%;
    }

    .leaflet-popup-content-wrapper {
      background: #111;
      color: #fff;
    }

    .leaflet-popup-tip {
      background: #111;
    }

    .btn-select {
      background: #fff;
      color: #000;
      border: none;
      width: 100%;
      padding: 6px;
      font-weight: 600;
    }
  </style>
</head>

<body>

<!-- USER PROTECTION -->
<script>
if (!sessionStorage.getItem("userPhone")) {
  window.location.href = "user-otp.html";
}
</script>

<!-- TOP BAR -->
<div class="topbar">
  <h5><i class="bi bi-geo-alt-fill"></i> Nearby Vehicles</h5>
  <button class="btn btn-outline-light btn-sm" onclick="logout()">
    <i class="bi bi-box-arrow-right"></i>
  </button>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
function logout() {
  sessionStorage.removeItem("userPhone");
  window.location.href = "index.html";
}

// Vehicle icon (sticker-style)
const vehicleIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/741/741407.png",
  iconSize: [38, 38],
  iconAnchor: [19, 38],
  popupAnchor: [0, -35]
});

navigator.geolocation.getCurrentPosition(
  async (pos) => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    const map = L.map("map").setView([lat, lng], 14);

    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(map);

    // User location
    L.marker([lat, lng])
      .addTo(map)
      .bindPopup("You are here")
      .openPopup();

    // Load vehicles from backend
    const res = await fetch("http://localhost:5000/vehicles");
    const vehicles = await res.json();

    vehicles.forEach((v, i) => {
      const offsetLat = (i % 4) * 0.001;
      const offsetLng = (i % 3) * -0.001;

      L.marker([lat + offsetLat, lng + offsetLng], { icon: vehicleIcon })
        .addTo(map)
        .bindPopup(`
          <strong>${v.name}</strong><br>
          ₹${v.price}/hour<br><br>
          <button class="btn-select" onclick="selectVehicle('${v.name}')">
            Select
          </button>
        `);
    });
  },
  () => alert("Location permission required")
);

function selectVehicle(name) {
  sessionStorage.setItem("selectedVehicle", name);
  window.location.href = "user.html";
}
</script>

</body>
</html>
